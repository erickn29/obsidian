Давайте обсудим, как создать и управлять циклом событий в [[asyncio]]. Цикл событий - это центральный компонент любого асинхронного приложения, который управляет выполнением задач и обработкой событий.

### Создание и управление циклом событий

Мы можем создать цикл событий, воспользовавшись методом `asyncio.new_event_loop`. Этот метод возвращает экземпляр цикла событий, предоставляющий доступ ко всем низкоуровневым методам, включая `run_until_complete`. Этот метод принимает сопрограмму и исполняет её до завершения. Завершив работу с циклом событий, необходимо закрыть его, чтобы освободить ресурсы. Обычно это делается в блоке `finally`, чтобы цикл закрывался даже в случае исключения.

### Пример создания цикла событий и выполнения задачи

```python
import asyncio

async def main():
    await asyncio.sleep(1)

# Создаем цикл событий
loop = asyncio.new_event_loop()
try:
    # Запускаем главную сопрограмму до её завершения
    loop.run_until_complete(main())
finally:
    # Закрываем цикл событий
    loop.close()
```

Этот код аналогичен тому, что происходит при вызове `asyncio.run`, за исключением того, что оставшиеся задачи не отменяются автоматически. Если вам нужна специальная логика очистки, её следует реализовать в блоке `finally`.

### Доступ к текущему циклу событий

Иногда требуется доступ к текущему циклу событий. Для этого библиотека asyncio предоставляет функцию `asyncio.get_running_loop`.

### Пример использования `asyncio.get_running_loop`

```python
import asyncio

def call_later():
    print("Меня вызовут в ближайшем будущем!")

async def delay(delay_seconds: int) -> int:
    print(f'засыпаю на {delay_seconds} с')
    await asyncio.sleep(delay_seconds)
    print(f'сон в течение {delay_seconds} с закончился')
    return delay_seconds

async def main():
    # Получаем текущий цикл событий
    loop = asyncio.get_running_loop()
    # Планируем вызов функции call_later
    loop.call_soon(call_later)
    await delay(1)

asyncio.run(main())
```

В этом примере мы используем `asyncio.get_running_loop` для получения текущего цикла событий и планируем вызов функции `call_later` с помощью метода `call_soon`. Эта функция будет вызвана в ближайшем будущем, после того как текущие задачи будут выполнены.

### Итог

Цикл событий в asyncio позволяет управлять асинхронными задачами и обработкой событий. Создавая новый цикл событий с помощью `asyncio.new_event_loop`, мы можем контролировать его выполнение и завершение. Функция `asyncio.get_running_loop` позволяет получить текущий цикл событий для планирования новых задач и вызовов. Эти инструменты помогают эффективно управлять асинхронными операциями и обеспечивать конкурентное выполнение кода в одном потоке.